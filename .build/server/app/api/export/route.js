"use strict";(()=>{var t={};t.id=5711,t.ids=[5711],t.modules={53524:t=>{t.exports=require("@prisma/client")},20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55315:t=>{t.exports=require("path")},61420:(t,a,e)=>{e.r(a),e.d(a,{originalPathname:()=>y,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m});var r={};e.r(r),e.d(r,{GET:()=>d,dynamic:()=>l});var n=e(79182),o=e(72007),i=e(56719),c=e(93442),u=e(74010),s=e(12203);let l="force-dynamic";async function d(){try{let t=await (0,u.Xp)();if(!t||0===t.length)return c.NextResponse.json({error:"Brak produkt\xf3w do eksportu"},{status:404});let a=s.P6.book_new(),e=[["Lp.","Nazwa Produktu","Jednostka Miary","Aktualny Stan"],...t.map((t,a)=>[a+1,t?.name||"",t?.unit||"",t?.currentStock||0])],r=s.P6.aoa_to_sheet(e);for(let e of(r["!cols"]=[{width:10},{width:30},{width:15},{width:15}],s.P6.book_append_sheet(a,r,"Lista Produkt\xf3w"),t))if(e?.id)try{let t=await (0,u.gk)(e.id);if(!t?.transactions)continue;let r=[];if(r.push(["INFORMACJE O PRODUKCIE"]),r.push(["Nazwa produktu:",t?.name||""]),r.push(["Jednostka miary:",t?.unit||""]),t?.manufacturer&&r.push(["Producent:",t.manufacturer]),t?.calories||t?.salt||t?.protein||t?.fat||t?.saturatedFat||t?.carbohydrates||t?.sugars||t?.calcium||t?.iron||t?.vitaminC){r.push([]);let a=t?.unit==="ml"||t?.unit==="l"?"100 ml":"100 g";r.push([`WARTOÅšCI ODÅ»YWCZE (na ${a})`]),t?.calories!=null&&r.push(["Kalorie:",`${t.calories} kcal`]),t?.protein!=null&&r.push(["BiaÅ‚ko:",`${t.protein} g`]),t?.fat!=null&&r.push(["TÅ‚uszcz:",`${t.fat} g`]),t?.saturatedFat!=null&&r.push(["  w tym kwasy tÅ‚uszczowe nasycone:",`${t.saturatedFat} g`]),t?.carbohydrates!=null&&r.push(["WÄ™glowodany:",`${t.carbohydrates} g`]),t?.sugars!=null&&r.push(["  w tym cukry:",`${t.sugars} g`]),t?.salt!=null&&r.push(["S\xf3l:",`${t.salt} g`]),t?.calcium!=null&&r.push(["WapÅ„:",`${t.calcium} mg`]),t?.iron!=null&&r.push(["Å»elazo:",`${t.iron} mg`]),t?.vitaminC!=null&&r.push(["Witamina C:",`${t.vitaminC} mg`])}r.push([]),r.push([]),r.push(["HISTORIA TRANSAKCJI"]),r.push(["Data","Dokument","Przych\xf3d","Rozch\xf3d","Saldo"]),t.transactions.forEach(t=>{let a=t?.type==="INCOME"&&t?.quantity||0,e=t?.type==="OUTCOME"&&t?.quantity||0;r.push([t?.date?new Date(t.date).toLocaleDateString("pl-PL"):"",t?.document||"",a.toString(),e.toString(),(t?.balance||0).toString()])});let n=s.P6.aoa_to_sheet(r);n["!cols"]=[{width:20},{width:30},{width:12},{width:12},{width:12}];let o=(e?.name||"Produkt").replace(/[\/\\?*:[\]]/g,"").substring(0,31);s.P6.book_append_sheet(a,n,o)}catch(t){console.error(`Error processing product ${e.name}:`,t);continue}let n=s.cW(a,{type:"buffer",bookType:"xlsx"});return new c.NextResponse(n,{status:200,headers:{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":`attachment; filename="kartoteka_magazynowa_${new Date().toISOString().split("T")[0]}.xlsx"`}})}catch(t){return console.error("Export error:",t),c.NextResponse.json({error:"BÅ‚Ä…d podczas eksportu danych"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/export/route",pathname:"/api/export",filename:"route",bundlePath:"app/api/export/route"},resolvedPagePath:"/home/ubuntu/kartoteka_magazynowa_app/nextjs_space/app/api/export/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:w}=p,y="/api/export/route";function k(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}},74010:(t,a,e)=>{e.d(a,{I1:()=>d,Xp:()=>c,_X:()=>l,gk:()=>u,ry:()=>s,vQ:()=>p});var r=e(83178),n=e(12203),o=e(55315),i=e.n(o);async function c(){try{return await r._.product.findMany({orderBy:{name:"asc"},where:{NOT:{name:"Lp."}}})}catch(t){return console.error("Error fetching products:",t),[]}}async function u(t){try{return await r._.product.findUnique({where:{id:t},include:{transactions:{orderBy:{date:"asc"}}}})}catch(t){return console.error("Error fetching product:",t),null}}async function s(t){try{return await r._.$transaction(async a=>{let e=await a.product.create({data:{name:t.name,unit:t.unit,currentStock:t.initialStock,manufacturer:t.manufacturer,calories:t.calories,salt:t.salt,protein:t.protein,fat:t.fat,saturatedFat:t.saturatedFat,carbohydrates:t.carbohydrates,sugars:t.sugars,calcium:t.calcium,iron:t.iron,vitaminC:t.vitaminC}});return t.initialStock>0&&await a.transaction.create({data:{productId:e.id,date:new Date,document:"Stan poczÄ…tkowy",type:"INCOME",quantity:t.initialStock,balance:t.initialStock}}),e})}catch(t){throw console.error("Error creating product:",t),t}}async function l(t,a){try{return await r._.$transaction(async e=>{let r=await e.product.findUnique({where:{id:t}});if(!r)throw Error("Product not found");let n=r.currentStock;if("INCOME"===a.type?n+=a.quantity:n-=a.quantity,n<0)throw Error("NiewystarczajÄ…cy stan magazynowy");let o=await e.transaction.create({data:{productId:t,date:a.date,document:a.document,type:a.type,quantity:a.quantity,balance:n}});return await e.product.update({where:{id:t},data:{currentStock:n}}),o})}catch(t){throw console.error("Error creating transaction:",t),t}}async function d(t){try{return await r._.$transaction(async a=>{let e=await a.transaction.findMany({where:{productId:t},orderBy:{date:"asc"}}),r=0;for(let t of e)"INCOME"===t.type?r+=t.quantity:r-=t.quantity,await a.transaction.update({where:{id:t.id},data:{balance:r}});return await a.product.update({where:{id:t},data:{currentStock:r}}),r})}catch(t){throw console.error("Error recalculating balances:",t),t}}async function p(){try{console.log("\uD83C\uDF31 Rozpoczynam import danych z pliku Excel...");let t=i().join(process.cwd(),"data","Kartoteka_Magazynowa_W_Malej_Kuchni.xlsx"),a=n.pJ(t);console.log("\uD83D\uDCCA Znalezione arkusze:",a.SheetNames);let e=a.SheetNames.find(t=>t.includes("Lista Produkt\xf3w")||t.includes("Arkusz1")||t===a.SheetNames[0])||a.SheetNames[0];console.log(`ðŸ“‹ Przetwarzam gÅ‚\xf3wny arkusz: ${e}`);let o=a.Sheets[e],c=n.P6.sheet_to_json(o);console.log(`ðŸ“¦ Znaleziono ${c.length} produkt\xf3w`);for(let t=0;t<c.length;t++){let o=c[t],i=o["Nazwa Produktu"]||o["Nazwa produktu"]||o.Nazwa||o["Product Name"]||o.Name||o.nazwa||Object.values(o).find(t=>"string"==typeof t&&t.length>2),u=o["Jednostka Miary"]||o["Jednostka miary"]||o.Jednostka||o.Unit||o.jednostka||"szt",s=parseFloat(o["Aktualny Stan"]||o.Stan||o.Stock||o.stan||"0")||0;if(!i){console.log(`âš ï¸  PominiÄ™to wiersz ${t+1} - brak nazwy produktu`);continue}console.log(`âž• DodajÄ™ produkt: ${i} (${u}, stan: ${s})`);let l=await r._.product.create({data:{name:String(i).trim(),unit:String(u).trim(),currentStock:s}}),d=a.SheetNames.find(t=>t.includes(String(i))||String(i).includes(t)||t===String(i));if(d&&d!==e){console.log(`ðŸ“ˆ Przetwarzam transakcje dla produktu z arkusza: ${d}`);let t=a.Sheets[d],e=n.P6.sheet_to_json(t),o=0;for(let t of e){let a=t.Data||t.Date||new Date,e=t.Dokument||t.Document||"Import",n=parseFloat(t["Przych\xf3d"]||t.Income||"0")||0,i=parseFloat(t["Rozch\xf3d"]||t.Outcome||"0")||0,c=parseFloat(t.Saldo||t.Balance||"0")||0;0!==c?o=c:o+=n-i,n>0&&await r._.transaction.create({data:{productId:l.id,date:new Date(a),document:String(e),type:"INCOME",quantity:n,balance:o}}),i>0&&await r._.transaction.create({data:{productId:l.id,date:new Date(a),document:String(e),type:"OUTCOME",quantity:i,balance:o}})}o!==s&&await r._.product.update({where:{id:l.id},data:{currentStock:o}}),console.log(`âœ… Zaimportowano ${e.length} transakcji dla produktu ${i}`)}else s>0&&await r._.transaction.create({data:{productId:l.id,date:new Date,document:"Stan poczÄ…tkowy",type:"INCOME",quantity:s,balance:s}})}let u=await r._.product.count(),s=await r._.transaction.count();console.log(`ðŸŽ‰ Import zakoÅ„czony pomyÅ›lnie!`),console.log(`ðŸ“¦ Zaimportowano ${u} produkt\xf3w`),console.log(`ðŸ“ˆ Zaimportowano ${s} transakcji`)}catch(t){throw console.error("âŒ BÅ‚Ä…d podczas importu:",t),t}}},83178:(t,a,e)=>{e.d(a,{_:()=>n});var r=e(53524);let n=globalThis.prisma??new r.PrismaClient}};var a=require("../../../webpack-runtime.js");a.C(t);var e=t=>a(a.s=t),r=a.X(0,[4372,7609,2203],()=>e(61420));module.exports=r})();